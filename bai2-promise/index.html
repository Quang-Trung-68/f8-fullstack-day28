<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài 2: Refactor với Promise</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-result, .posts-list, .todo-list {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            min-height: 50px;
        }
        
        .post-id-1, .post-id-2, .post-id-3, .post-id-4, .post-id-5,
        .post-id-6, .post-id-7, .post-id-8, .post-id-9, .post-id-10 {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .comments {
            margin-top: 10px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 4px;
        }
        
        .comment {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .comment-userinfo {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .todo-completed {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            margin: 5px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .todo-incomplete {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            margin: 5px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .error {
            color: red;
            margin: 10px 0;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-text {
            background: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .retry-info {
            color: orange;
            font-style: italic;
            margin: 5px 0;
        }
        
        .load-more-btn {
            background: #28a745;
        }
        
        .load-more-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <h1>Bài 2: XHR với Promise Pattern</h1>
    
    <div class="section">
        <h2>Chức năng 1: User Profile Card</h2>
        <form>
            <input class="user-id-input" type="number" min="1" max="10" step="1" placeholder="Nhập User ID (1-10)">
            <button type="button" class="find-user">Tìm User</button>
        </form>
        <div class="user-result">
            <div class="user-name"></div>
            <div class="user-email"></div>
            <div class="user-phone"></div>
            <div class="user-website"></div>
            <div class="user-company"></div>
            <div class="user-address"></div>
        </div>
        <div class="find-user-error error"></div>
        <div class="find-user-retry retry-info"></div>
    </div>
    
    <div class="section">
        <h2>Chức năng 2: Posts với Comments</h2>
        <div class="posts-list"></div>
        <button type="button" class="load-more-btn">Xem thêm 5 posts</button>
        <div class="post-error error"></div>
        <div class="post-retry retry-info"></div>
    </div>
    
    <div class="section">
        <h2>Chức năng 3: Todo List với Filter</h2>
        <div>
            <input class="user-id-input-todo" type="number" min="1" max="10" step="1" placeholder="Nhập User ID (1-10)">
            <button type="button" class="all-todo-btn">Tất cả</button>
            <button type="button" class="complete-todo-btn">Đã hoàn thành</button>
            <button type="button" class="incomplete-todo-btn">Chưa hoàn thành</button>
        </div>
        <div>
            <div class="number-todo">0</div>
            <div class="todo-list"></div>
        </div>
        <div class="todo-error error"></div>
        <div class="todo-retry retry-info"></div>
    </div>

    <div class="loading-overlay" style="display:none;">
        <div class="loading-text">Đang tải...</div>
    </div>

    <script>
        const findUserBtn = document.querySelector(".find-user");
        const userIdInput = document.querySelector(".user-id-input");
        const userName = document.querySelector(".user-name");
        const userEmail = document.querySelector(".user-email");
        const userPhone = document.querySelector(".user-phone");
        const userWebsite = document.querySelector(".user-website");
        const userCompany = document.querySelector(".user-company");
        const userAddress = document.querySelector(".user-address");
        const findUserError = document.querySelector(".find-user-error");
        const findUserRetry = document.querySelector(".find-user-retry");
        const userResult = document.querySelector(".user-result");
        const baseUrl = "https://jsonplaceholder.typicode.com";

        const postsList = document.querySelector(".posts-list");
        const postError = document.querySelector(".post-error");
        const postRetry = document.querySelector(".post-retry");
        const loadMoreBtn = document.querySelector(".load-more-btn");

        const numberTodo = document.querySelector(".number-todo");
        const userIdInputTodo = document.querySelector(".user-id-input-todo");
        const todoList = document.querySelector(".todo-list");
        const todoError = document.querySelector(".todo-error");
        const todoRetry = document.querySelector(".todo-retry");
        const allTodoBtn = document.querySelector(".all-todo-btn");
        const completeTodoBtn = document.querySelector(".complete-todo-btn");
        const incompleteTodoBtn = document.querySelector(".incomplete-todo-btn");

        const loadingOverlay = document.querySelector(".loading-overlay");

        let todoData = null;
        let currentPostsLoaded = 5;

        // 2.1: Promise wrapper cho XHR
        function sendRequest(method, url) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open(method, url);

                loadingOverlay.style.display = "flex";

                xhr.onload = function () {
                    loadingOverlay.style.display = "none";
                    if (this.status >= 200 && this.status < 400) {
                        const data = JSON.parse(this.responseText);
                        resolve(data);
                    } else {
                        reject(new Error("Request failed with status: " + this.status));
                    }
                };

                xhr.onerror = function () {
                    loadingOverlay.style.display = "none";
                    reject(new Error("Network error occurred"));
                };

                xhr.send();
            });
        }

        // 2.3: Retry mechanism
        function sendRequestWithRetry(method, url, retryElement = null, maxRetries = 1) {
            let retryCount = 0;
            
            function attemptRequest() {
                if (retryElement && retryCount > 0) {
                    retryElement.textContent = `Đang thử lại lần ${retryCount}/${maxRetries}...`;
                }
                
                return sendRequest(method, url)
                    .catch(error => {
                        if (retryCount < maxRetries) {
                            retryCount++;
                            if (retryElement) {
                                retryElement.textContent = `Lỗi! Sẽ thử lại sau 2 giây... (Lần ${retryCount}/${maxRetries})`;
                            }
                            return new Promise(resolve => {
                                setTimeout(() => {
                                    resolve(attemptRequest());
                                }, 2000);
                            });
                        } else {
                            if (retryElement) {
                                retryElement.textContent = `Đã thử ${maxRetries + 1} lần, vẫn thất bại!`;
                            }
                            throw error;
                        }
                    });
            }
            
            return attemptRequest()
                .then(result => {
                    if (retryElement) {
                        retryElement.textContent = retryCount > 0 ? `Thành công sau ${retryCount} lần thử lại!` : '';
                    }
                    return result;
                });
        }

        // 2.2: Refactor chức năng 1 - User Profile Card
        function displayUser(data) {
            userName.textContent = data ? "Name: " + data.name : "";
            userEmail.textContent = data ? "Email: " + data.email : "";
            userPhone.textContent = data ? "Phone: " + data.phone : "";
            userWebsite.textContent = data ? "Website: " + data.website : "";
            userCompany.textContent = data ? "Company: " + data.company.name : "";
            userAddress.textContent = data ? 
                "Address: " + data.address.street + ", " + data.address.city : "";
        }

        function clearUserError() {
            findUserError.textContent = "";
            findUserRetry.textContent = "";
        }

        findUserBtn.addEventListener("click", () => {
            if (!userIdInput.value) {
                findUserError.textContent = "Vui lòng nhập User ID!";
                return;
            }

            clearUserError();
            displayUser(null);

            const url = `${baseUrl}/users/${userIdInput.value}`;
            
            sendRequestWithRetry("GET", url, findUserRetry)
                .then(data => {
                    displayUser(data);
                })
                .catch(error => {
                    findUserError.textContent = error.message;
                    console.log(error);
                });
        });

        // 2.2: Refactor chức năng 2 - Posts với Comments (Promise Chain)
        function loadComments(userId, postId) {
            const urlUser = `${baseUrl}/users/${userId}`;
            const urlComments = `${baseUrl}/posts/${postId}/comments`;

            // Promise chain để tránh callback hell
            return sendRequestWithRetry("GET", urlUser, postRetry)
                .then(userData => {
                    return sendRequestWithRetry("GET", urlComments, postRetry)
                        .then(commentsData => {
                            return { userData, commentsData };
                        });
                })
                .then(({ userData, commentsData }) => {
                    const postDiv = document.querySelector(`.post-id-${postId}`);
                    
                    // Xóa comments cũ nếu có
                    let oldComments = postDiv.querySelector(".comments");
                    if (oldComments) oldComments.remove();

                    // Tạo container cho comments
                    const commentsContainer = document.createElement("div");
                    commentsContainer.className = "comments";

                    // Thêm thông tin user
                    const userInfo = document.createElement("div");
                    userInfo.className = "comment-userinfo";
                    userInfo.textContent = `User: ${userData.name} (${userData.email})`;
                    commentsContainer.appendChild(userInfo);

                    // Thêm từng comment
                    commentsData.forEach(comment => {
                        const commentDiv = document.createElement("div");
                        commentDiv.className = "comment";
                        commentDiv.textContent = `${comment.name}: ${comment.body}`;
                        commentsContainer.appendChild(commentDiv);
                    });

                    postDiv.appendChild(commentsContainer);
                })
                .catch(error => {
                    postError.textContent = error.message;
                    console.log(error);
                });
        }

        function displayPosts(posts) {
            const postsHTML = posts.map(post => {
                return `<div class="post-id-${post.id}">
                    <div class="post-userid">UserID: ${post.userId}</div>
                    <div class="post-id">ID: ${post.id}</div>
                    <div class="post-title">Title: ${post.title}</div>
                    <div class="post-body">Body: ${post.body}</div>
                    <button type="button" class="comment-btn" data-post-id="${post.id}" data-user-id="${post.userId}">Xem comments</button>
                </div>`;
            }).join("");

            return postsHTML;
        }

        function bindCommentEvents() {
            document.querySelectorAll(".comment-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const postId = btn.dataset.postId;
                    const userId = btn.dataset.userId;
                    loadComments(userId, postId);
                });
            });
        }

        function loadPosts(limit = 5, append = false) {
            postError.textContent = "";
            postRetry.textContent = "";
            
            const url = `${baseUrl}/posts?_limit=${limit}`;
            
            sendRequestWithRetry("GET", url, postRetry)
                .then(posts => {
                    const postsHTML = displayPosts(posts);
                    if (append) {
                        postsList.innerHTML += postsHTML;
                    } else {
                        postsList.innerHTML = postsHTML;
                    }
                    bindCommentEvents();
                })
                .catch(error => {
                    postError.textContent = error.message;
                    console.log(error);
                });
        }

        // Load more functionality
        loadMoreBtn.addEventListener("click", () => {
            currentPostsLoaded += 5;
            loadPosts(currentPostsLoaded, false);
        });

        // 2.2: Refactor chức năng 3 - Todo List với Filter
        function displayTodos(todos) {
            const todosHTML = todos.map(todo => {
                const cls = todo.completed ? "todo-completed" : "todo-incomplete";
                return `<div class="${cls}">
                    <div>UserId: ${todo.userId}</div>
                    <div>Id: ${todo.id}</div>
                    <div>Title: ${todo.title}</div>
                    <div>Completed: ${todo.completed}</div>
                </div>`;
            }).join("");
            
            todoList.innerHTML = todosHTML;
            numberTodo.textContent = todos.length;
        }

        function loadTodos() {
            if (!userIdInputTodo.value) {
                todoError.textContent = "Vui lòng nhập User ID!";
                return Promise.reject(new Error("Missing User ID"));
            }

            todoError.textContent = "";
            todoRetry.textContent = "";
            
            const url = `${baseUrl}/users/${userIdInputTodo.value}/todos`;
            
            return sendRequestWithRetry("GET", url, todoRetry)
                .then(data => {
                    todoData = data;
                    displayTodos(data);
                    return data;
                })
                .catch(error => {
                    todoError.textContent = error.message;
                    console.log(error);
                    throw error;
                });
        }

        allTodoBtn.addEventListener("click", () => {
            loadTodos();
        });

        completeTodoBtn.addEventListener("click", () => {
            if (!todoData) {
                loadTodos()
                    .then(() => {
                        const completedTodos = todoData.filter(todo => todo.completed);
                        displayTodos(completedTodos);
                    });
            } else {
                const completedTodos = todoData.filter(todo => todo.completed);
                displayTodos(completedTodos);
            }
        });

        incompleteTodoBtn.addEventListener("click", () => {
            if (!todoData) {
                loadTodos()
                    .then(() => {
                        const incompleteTodos = todoData.filter(todo => !todo.completed);
                        displayTodos(incompleteTodos);
                    });
            } else {
                const incompleteTodos = todoData.filter(todo => !todo.completed);
                displayTodos(incompleteTodos);
            }
        });

        // Initial load
        loadPosts(5);
    </script>
</body>
</html>